<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Админка меню</title>
    <style>
        table, td, th {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 6px;
            margin-bottom: 20px;
        }
        h3 {
            margin-top: 30px;
        }
        #new-item {
            margin-bottom: 30px;
        }
        #new-item label {
            margin-right: 10px;
        }
        #new-item input, #new-item select {
            margin-right: 20px;
        }
        
        #login-box {
            margin-top: 80px;
            text-align: center;
        }
        
        #admin-content {
            display: none;
        }

        input {
            padding: 6px;
            margin: 4px;
            font-size: 16px;
        }
        button {
            padding: 6px 16px;
        }
    </style>
</head>
<body>
    <div id="login-box">
        <h2>Вход</h2>
        <input type="text" id="username" placeholder="Имя пользователя">
        <input type="password" id="password" placeholder="Пароль">
        <button onclick="login()">Войти</button>
    </div>

    <div id="admin-content">
        
    <h2>Добавить новое блюдо</h2>
    <div id="new-item">
        <label>Категория: </label>
        <select id="new-item-category"></select>
        <label>Название: </label>
        <input type="text" id="new-item-name">
        <label>Цена: </label>
        <input type="number" id="new-item-price">
        <label>
            <input type="checkbox" id="new-item-available" checked> Доступно
        </label>
        <button onclick="addNewItem()">Добавить</button>
    </div>

    <h2>Редактирование меню</h2>
    <div id="categories"></div>

    <button onclick="saveMenu()">Сохранить изменения</button>

<script>
let menuData = null;

// Загрузка меню и рендер
async function loadMenu() {
    const res = await fetch("/api/menu");
    menuData = await res.json();

    const container = document.getElementById("categories");
    container.innerHTML = "";

    menuData.categories.forEach((category, catIndex) => {
        const title = document.createElement("h3");
        title.innerText = category.name;
        container.appendChild(title);

        const table = document.createElement("table");
        table.dataset.index = catIndex;

        // Header
        const head = table.insertRow();
        ["available", "id", "name", "price"].forEach(col => {
            const th = document.createElement("th");
            th.innerText = col;
            head.appendChild(th);
        });

        // Items
        category.items.forEach(item => {
            const row = table.insertRow();

            Object.keys(item).forEach(key => {
                const cell = row.insertCell();
                cell.contentEditable = key !== "available";

                if (key === "available") {
                    cell.innerHTML = `<input type="checkbox" ${item[key] ? "checked" : ""}>`;
                } else {
                    cell.innerText = item[key];
                }
            });
        });

        container.appendChild(table);
    });

    populateCategorySelect();
}

// Сохранение изменений меню
async function saveMenu() {
    const container = document.getElementById("categories");
    const tables = container.getElementsByTagName("table");

    let newCategories = [];

    for (let table of tables) {
        let catIndex = Number(table.dataset.index);
        let category = menuData.categories[catIndex];

        let rows = table.rows; 
        let items = [];

        for (let i = 1; i < rows.length; i++) {
            const cells = rows[i].cells;

            items.push({
                id: cells[1].innerText,
                name: cells[2].innerText,
                price: Number(cells[3].innerText),
                available: cells[0].querySelector("input").checked
            });
        }

        newCategories.push({
            name: category.name,
            items: items
        });
    }

    const body = {
        last_updated: new Date().toISOString(),
        currency: menuData.currency,
        categories: newCategories
    };

    await fetch("/api/menu", {
        method: "PUT",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(body)
    });

    alert("Изменения сохранены!");
}

// Добавление нового блюда
function addNewItem() {
    const categoryName = document.getElementById("new-item-category").value;
    const name = document.getElementById("new-item-name").value.trim();
    const price = Number(document.getElementById("new-item-price").value);
    const available = document.getElementById("new-item-available").checked;

    if (!name || !price) {
        alert("Заполни название и цену");
        return;
    }

    const payload = {
        category: categoryName,
        name: name,
        price: price,
        available: available
    };

    fetch("/api/menu/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert("Блюдо добавлено");
            return fetch("/api/menu");
        } else {
            throw new Error("Ошибка добавления блюда");
        }
    })
    .then(res => res.json())
    .then(newMenu => {
        menuData = newMenu;
        loadMenu(); // перерендер таблицы
        document.getElementById("new-item-name").value = "";
        document.getElementById("new-item-price").value = "";
        document.getElementById("new-item-available").checked = true;
    })
    .catch(err => console.error(err));
}

// Заполнение select категорий
function populateCategorySelect() {
    const select = document.getElementById("new-item-category");
    select.innerHTML = "";
    menuData.categories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat.name;
        opt.textContent = cat.name;
        select.appendChild(opt);
    });
}

// Инициализация
loadMenu();
</script>

<script>
    const LOGIN = "admin"
    const PASSWORD = "1111"
    

    function login() {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        
        if (username === LOGIN && password === PASSWORD) {
            document.getElementById("login-box").style.display = "none";
            document.getElementById("admin-content").style.display = "block";
        } else {
            alert("Неверный логин или пароль");
        }
    }
</script>
</body>
</html>
